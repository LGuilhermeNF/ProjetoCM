unit uFrmConectarAPI;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ExtCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.ComCtrls, uConexaoAPI, System.StrUtils;

type
  TfrmConectaAPI = class(TForm)
    Panel1: TPanel;
    edtURL: TLabeledEdit;
    btnConectar: TBitBtn;
    Panel2: TPanel;
    dsAPI: TDataSource;
    Panel3: TPanel;
    ProgressBar: TProgressBar;
    Label1: TLabel;
    btnSincronizar: TBitBtn;
    btnSair: TBitBtn;
    lblConexaoAPI: TLabel;
    procedure btnConectarClick(Sender: TObject);
    procedure btnSincronizarClick(Sender: TObject);
    procedure btnSairClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
  private
    { Private declarations }
    FError: String;
    FBaseUrl: String;
    FResource: String;
    FConectado: Boolean;
  public
    { Public declarations }
    procedure ConectarAPI;
    procedure SincornizarBaseDados;
  end;

var
  frmConectaAPI: TfrmConectaAPI;

implementation

{$R *.dfm}

procedure TfrmConectaAPI.btnConectarClick(Sender: TObject);
begin
  ConectarAPI;
end;

procedure TfrmConectaAPI.btnSairClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmConectaAPI.btnSincronizarClick(Sender: TObject);
begin
  SincornizarBaseDados;
end;

procedure TfrmConectaAPI.ConectarAPI;
var
  LConexaoAPI: TConexaoAPI;
begin

  FBaseUrl := edtURL.Text;
  if FBaseUrl = EmptyStr then
  begin
    MessageBox(handle,'Favor informar a URL para conexão com a Aplicação','Erro', MB_ICONERROR + MB_OK);
    edtURL.SetFocus;
  end;

  LConexaoAPI := TConexaoAPI.Create;
  try
    try
      if TConexaoAPI.ConectarAPI('posts', FBaseUrl, FError) then
      begin
        btnSincronizar.Enabled := True;
        FConectado := True;
      end;
    except on E: Exception do
      begin
        MessageBox(handle,PWideChar(FError),'Erro', MB_ICONERROR + MB_OK);
        FConectado := False;
      end;
    end;
  finally
    FreeAndNil(LConexaoAPI);
  end;

  MessageBox(handle,'Conexão realizada com sucesso!','Conexão', MB_ICONINFORMATION + MB_OK);
  lblConexaoAPI.Visible := True;
end;

procedure TfrmConectaAPI.FormShow(Sender: TObject);
begin
  lblConexaoAPI.Visible := False;
end;

procedure TfrmConectaAPI.SincornizarBaseDados;
begin
  if FConectado then
    begin
      TConexaoAPI.SincronizarAPI;
      ProgressBar.Position := TConexaoAPI.ProgressStep;
    end;
end;

end.
